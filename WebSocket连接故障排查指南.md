# WebSocket连接故障排查指南

## 问题概述

您可能遇到了以下错误信息：

```
Failed to load resource: net::ERR_CONNECTION_REFUSED
WebSocket连接错误: TransportError: xhr poll error
信令服务器连接失败，视频通话功能可能不可用
Socket.io连接错误: TransportError: xhr poll error
```

这些错误表明前端应用无法连接到信令服务器（端口5001），导致视频通话和实时通讯功能不可用。

## 常见原因分析

1. **后端服务未启动**：最常见的原因是后端服务（server.js）未正常启动或已停止运行
2. **端口冲突**：端口5001被其他应用程序占用
3. **网络配置问题**：防火墙或安全软件阻止了WebSocket连接
4. **服务启动顺序错误**：后端服务应在前端服务之前启动
5. **Node.js环境问题**：Node.js版本不兼容或未正确安装

## 详细诊断步骤

### 1. 检查后端服务状态

运行`检查服务状态.bat`工具，它会：
- 检查Node.js环境是否正确安装
- 检查端口5001是否被占用
- 检查前端和后端服务是否正常运行
- 检查server.js文件是否存在
- 检查WebSocket配置文件是否存在

### 2. 检查控制台错误信息

在浏览器中按F12打开开发者工具，查看控制台中的错误信息：

- `Failed to load resource: net::ERR_CONNECTION_REFUSED`：表示无法连接到信令服务器
- `TransportError: xhr poll error`：表示WebSocket连接失败
- `信令服务器状态检查失败: TypeError: Failed to fetch`：表示信令服务器不可用

### 3. 检查网络连接

确保本地网络连接正常：
- 检查防火墙是否阻止了端口5001的连接
- 检查是否有VPN或代理服务影响了本地连接

## 解决方案

### 方案1：重启后端服务

1. 运行`检查服务状态.bat`
2. 选择选项1：重启后端服务和信令服务
3. 等待服务启动完成
4. 刷新前端页面

### 方案2：重启所有服务

如果仅重启后端服务无效，可以尝试重启所有服务：

1. 运行`检查服务状态.bat`
2. 选择选项2：重启所有服务（前端和后端）
3. 等待服务启动完成

### 方案3：释放被占用的端口

如果端口5001被其他程序占用：

1. 运行`检查服务状态.bat`
2. 选择选项3：检查并释放5001端口
3. 确认是否结束占用端口的进程
4. 重新运行脚本检查服务状态

### 方案4：深度修复

如果以上方法都无效：

1. 运行`检查服务状态.bat`
2. 选择选项4：深度修复WebSocket连接问题
3. 等待修复完成

## 高级故障排除

### 手动启动后端服务

如果自动修复工具无法解决问题，可以尝试手动启动服务：

1. 打开命令提示符（以管理员身份）
2. 导航到项目目录：`cd 项目路径`
3. 运行：`node server.js`
4. 观察是否有错误信息

### 检查Node.js版本

确保Node.js版本兼容：

1. 打开命令提示符
2. 运行：`node --version`
3. 确保版本在12.0或更高

### 检查依赖项

确保所有依赖项已正确安装：

1. 打开命令提示符
2. 导航到项目目录
3. 运行：`npm install`

## 预防措施

为避免将来出现类似问题：

1. 始终使用`一键启动服务.bat`启动应用
2. 确保先启动后端服务，再启动前端服务
3. 定期检查服务状态
4. 避免在端口5001上运行其他应用

## 联系支持

如果按照上述步骤操作后问题仍然存在，请联系技术支持团队并提供以下信息：

1. 错误信息截图
2. `logs`目录下的日志文件
3. 操作系统版本
4. Node.js版本

---

*本指南由太极禅道传统健康网站技术团队提供*